<html>
    <head>
            <meta charset="utf-8">
            <link rel="stylesheet" href="style.css"/>
            <script src="https://code.jquery.com/jquery-1.11.3.min.js"></script>
            <script src="jquery.querystring.js"></script>
            <script src="form.js"></script>
            <script src="settings.js"></script>
            <script src="articles.js"></script>
            <title>Stock 9231</title>
    </head>
    <body>
        <div class="cart">
            <div class="table" >
                <div class="layout-inline row th">
                    <div class="col col-pro">Articles</div>
                </div>
                <div id="articles">
                </div>
            </div>
            <p>
                <input id="email" placeholder="Mon email" oninput="saveEmail();"/><br />
                <textarea id="comment" placeholder="Commentaire (optionnel)" oninput="saveComment();"></textarea>
            </p>
        </p>
        <a href="#" onclick="delayedSend()" class="btn btn-update" id="send">Envoyer</a>
        <p id="flash">
            Commande envoy√©e
        </p>
        </div>
    </body>
    <script>

            var undodeletions = [];
            var sendinprogress = false;

            var articles = JSON.parse(localStorage.getItem('articles')) || [];

            /*
                grab code from querystring, if already exists in articles, increment by one
                otherwise create a new article with quantity 1
            */
            var query = $.querystring(location.search);
            var barcode = query.k.toString();
            if(barcode !== undefined){

                if(allarticles[barcode] !== undefined){

                    var article = articles.find(article => article.barcode === barcode);
                    if(article === undefined){
                        articles.push({
                            barcode : query.k.toString(),
                            display : allarticles[barcode],
                            quantity : 1
                        });
                    }

                    localStorage.setItem('articles', JSON.stringify(articles));
                } else {
                    alert('code bar inconnu');
                }
            }
            
            /*
                redraw the full article table, some optimization could be performed by only redrawing what changed
            */
            function drawTable(){
                var table = $('#articles');
                table.empty();
                $.each(articles, function (i,article){
                    var row = $('<div>').addClass('layout-inline row');

                    $('<div>').addClass('col col-pro layout-inline').html('<p>' + article.display + '</p>').appendTo(row);

                    if(article.quantity == 0){
                        $('<div>').addClass('col col-qty layout-inline').html('<a href="#" class="btn btn-cancel" onclick="undo(\'' + article.barcode + '\');">Annuler</a>').appendTo(row);
                    } else {                    
                        $('<div>').addClass('col col-qty layout-inline').html(
                            '<a href="#" onclick="changeQuantity(\'' + article.barcode + '\',-1)" class="qty qty-minus"><img src="waste.png" /></a>').appendTo(row);
                    }
                    
                    table.append(row);
                });
            }

            function changeQuantity(barcode,amount){

                var article = articles.find(article => article.barcode === barcode);
                if(article !== undefined){
                    article.quantity +=amount;

                    if(article.quantity == 0){
                            undodeletions.push(barcode);
                            setTimeout(function () { 
                                delayedDeletion(barcode);
                            }, 2000);
                        }
                }

                localStorage.setItem('articles', JSON.stringify(articles));
                drawTable();

                if(!$('#send').is(':visible')){
                    $('#send').toggle().toggleClass('btn-cancel').html("Envoyer");
                }
            }

            function undo(barcode){
                undodeletions.splice(undodeletions.indexOf(barcode),1);
                articles.find(article => article.barcode === barcode).quantity = 1;

                localStorage.setItem('articles', JSON.stringify(articles));
                drawTable();
            }

            function delayedDeletion(barcode){

                // we shouldn't even loop if undodeletions is empty, there is nothing to undo.
                if(undodeletions.length == 0){
                    return;
                }

                var article = articles.find(article => article.barcode === barcode && undodeletions.includes(barcode));
                if(article !== undefined){
                    articles.splice(articles.indexOf(article),1);
                    undodeletions.splice(undodeletions.indexOf(barcode),1);
                }

                localStorage.setItem('articles', JSON.stringify(articles));
                drawTable();
            }

            function delayedSend(){
                if($('#send').hasClass('btn-cancel')){
                    // we just cancelled the send
                    sendinprogress = false;
                    $('#send').toggleClass('btn-cancel').html("Envoyer");
                } else {
                    sendinprogress = true;
                    $('#send').toggleClass('btn-cancel').html("Annuler");
                    setTimeout(function () { 
                        send();
                    }, 4000);
                }
            }

            function send(){
                if(sendinprogress === false){
                    return;
                }
                var message = {
                    email : $('#email').val(),
                    comment : $('#comment').val(),
                    articles : articles
                };

                // storage service only init if actual send action (90% the page is only for feeding the cart)
                $.ajaxSetup({
                    cache: true
                });

                $.getScript('azure-storage.queue.min.js', function(){

                    var queueService = AzureStorage.Queue.createQueueServiceWithSas(settings.azurequeueuri, settings.azurestoragetoken);
                    var encoder = new AzureStorage.Queue.QueueMessageEncoder.TextBase64QueueMessageEncoder();

                    queueService.createMessage(settings.azurequeuename, encoder.encode(JSON.stringify(message)), function (error, results, response) {
                        if (error) {
                            $('#flash').html(error.message);
                            $('#flash').addClass('flasherror');
                        }
                    });

                    $('#send').toggle();
                    $('#flash').toggle();
                });
            }

            initializeForm();
            drawTable();
    </script>
</html>